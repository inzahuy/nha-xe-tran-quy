<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nhà Xe Trần Quý</title>
    <style>
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        .nav { background: #2c3e50; padding: 15px; color: white; display: flex; justify-content: space-between; }
        .nav a { color: white; margin-left: 15px; text-decoration: none; font-weight: bold; }
        .container { display: flex; max-width: 1000px; margin: 20px auto; gap: 20px; }
        .box { background: white; padding: 20px; border-radius: 8px; flex: 1; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .seat { height: 50px; background: #ddd; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 4px; }
        .seat.booked { background: #e74c3c; color: white; cursor: not-allowed; }
        .seat.selected { background: #27ae60; color: white; }
        input { width: 100%; padding: 8px; margin: 5px 0 10px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: #2980b9; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="nav">
        <div>NHÀ XE TRẦN QUÝ</div>
        <div>
            {% if current_user.is_authenticated %}
                <span>Xin chào, {{ current_user.username }}</span>
                <a href="/my-tickets">VÉ CỦA TÔI</a>
                <a href="/logout">Đăng xuất</a>
            {% else %}
                <a href="/login">Đăng Nhập</a>
                <a href="/register">Đăng Ký</a>
            {% endif %}
        </div>
    </div>

    <div class="container">
        <div class="box">
            <h3>Sơ Đồ Ghế</h3>
            <div class="grid" id="grid"></div>
        </div>
        <div class="box">
            <h3>Đặt Vé</h3>
            <form action="/book" method="POST" id="form">
                <input type="text" id="seat_show" readonly placeholder="Chọn ghế bên trái...">
                <input type="hidden" name="seat_id" id="seat_id">
                <input type="text" name="customer_name" placeholder="Họ tên" required>
                <input type="text" name="customer_phone" placeholder="Số điện thoại" required>
                <input type="date" name="travel_date" required>
                <input type="text" name="pickup_point" placeholder="Điểm đón" required>
                <input type="text" name="dropoff_point" placeholder="Điểm trả" required>
                <button type="submit">XÁC NHẬN ĐẶT</button>
            </form>
        </div>
    </div>

    <script>
        // Tao thêm dấu nháy ' ' để đánh lừa VS Code cho nó đỡ báo lỗi đỏ
        var bookedData = '{{ booked_seats|tojson|safe }}';
        var isLoggedData = '{{ "true" if current_user.is_authenticated else "false" }}';

        var booked = JSON.parse(bookedData);
        var isLoggedIn = (isLoggedData === 'true');
        
        for(let i=1; i<=24; i++) {
            let id = 'A' + i;
            let div = document.createElement('div');
            div.className = 'seat' + (booked.includes(id) ? ' booked' : '');
            div.innerText = id;
            if(!booked.includes(id)) {
                div.onclick = function() {
                    if(!isLoggedIn) {
                        alert("Vui lòng đăng nhập trước!");
                        window.location.href = '/login';
                        return;
                    }
                    document.querySelectorAll('.seat').forEach(s => s.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('seat_id').value = id;
                    document.getElementById('seat_show').value = "Ghế " + id;
                }
            }
            document.getElementById('grid').appendChild(div);
        }
    </script>
</body>
</html>